<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" 
           Name="PBS Plus Agent" 
           Language="1033" 
           Version="__VERSION__" 
           Manufacturer="Son Roy Almerol" 
           UpgradeCode="__UPGRADE_CODE__">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine" 
             Description="PBS Plus Agent Installer" />

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Custom UI for user input -->
    <UI>
      <UIRef Id="WixUI_InstallDir" />
    </UI>

    <!-- Properties for user input -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="SERVERURL" Secure="yes">
      <RegistrySearch Id="ServerUrlSearch" 
                      Root="HKLM" 
                      Key="SOFTWARE\PBSPlus\Config" 
                      Name="ServerURL" 
                      Type="raw" />
    </Property>
    <Property Id="BOOTSTRAPTOKEN" Secure="yes" />

    <!-- Custom dialogs for input -->
    <UI>
      <Dialog Id="ConfigDlg" Width="370" Height="270" Title="Configuration">
        <Control Id="ServerUrlLabel" Type="Text" X="20" Y="20" Width="320" Height="15" Text="Server URL:" />
        <Control Id="ServerUrlEdit" Type="Edit" X="20" Y="40" Width="320" Height="18" Property="SERVERURL" />
        
        <Control Id="BootstrapTokenLabel" Type="Text" X="20" Y="70" Width="320" Height="15" Text="Bootstrap Token:" />
        <Control Id="BootstrapTokenEdit" Type="Edit" X="20" Y="90" Width="320" Height="18" Property="BOOTSTRAPTOKEN" Password="yes" />
        
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="Back">
          <Publish Event="NewDialog" Value="InstallDirDlg">1</Publish>
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="Next">
          <Publish Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <InstallUISequence>
        <Show Dialog="ConfigDlg" After="InstallDirDlg">NOT Installed</Show>
      </InstallUISequence>
    </UI>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="PBS Plus Agent">
          <Component Id="PBSPlusAgentExe" Guid="__COMPONENT_GUID_1__">
            <File Id="PBSPlusAgent" Source="pbs-plus-agent.exe" KeyPath="yes" />
            <ServiceInstall Id="ServiceInstaller"
                          Type="ownProcess"
                          Name="PBSPlusAgent"
                          DisplayName="PBS Plus Agent"
                          Description="PBS Plus backup agent service"
                          Start="auto"
                          Account="LocalSystem"
                          ErrorControl="normal" />
            <ServiceControl Id="StartService" 
                          Start="install" 
                          Stop="both" 
                          Remove="uninstall" 
                          Name="PBSPlusAgent" 
                          Wait="yes" />
          </Component>
          
          <Component Id="PBSPlusUpdaterExe" Guid="__COMPONENT_GUID_2__">
            <File Id="PBSPlusUpdater" Source="pbs-plus-updater.exe" KeyPath="yes" />
            <ServiceInstall Id="UpdaterServiceInstaller"
                          Type="ownProcess"
                          Name="PBSPlusUpdater"
                          DisplayName="PBS Plus Updater"
                          Description="PBS Plus agent updater service"
                          Start="auto"
                          Account="LocalSystem"
                          ErrorControl="normal" />
            <ServiceControl Id="StartUpdaterService" 
                          Start="install" 
                          Stop="both" 
                          Remove="uninstall" 
                          Name="PBSPlusUpdater" 
                          Wait="yes" />
          </Component>

          <Component Id="RegistryEntries" Guid="__COMPONENT_GUID_3__">
            <RegistryKey Root="HKLM" Key="SOFTWARE\PBSPlus\Config">
              <RegistryValue Type="string" Name="ServerURL" Value="[SERVERURL]" KeyPath="yes" />
              <RegistryValue Type="string" Name="BootstrapToken" Value="[BOOTSTRAPTOKEN]" />
            </RegistryKey>
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Title="PBS Plus Agent" Level="1">
      <ComponentRef Id="PBSPlusAgentExe" />
      <ComponentRef Id="PBSPlusUpdaterExe" />
      <ComponentRef Id="RegistryEntries" />
    </Feature>
  </Product>
</Wix>
