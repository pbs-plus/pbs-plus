<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  
  <?define ProductName = "PBS Plus Agent" ?>
  <?define ProductVersion = "$(env.VERSION)" ?>
  <?define Manufacturer = "PBS Plus" ?>
  <?define UpgradeCode = "536F6BA8-2DBB-4D9D-A084-B64B99BBD3A0" ?>
  
  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">
    
    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"
             Description="PBS Plus Agent for Windows"
             Manufacturer="$(var.Manufacturer)" />

    <MajorUpgrade 
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowSameVersionUpgrades="yes" 
      AllowDowngrades="yes"
      Schedule="afterInstallInitialize" />
    
    <MediaTemplate EmbedCab="yes" />

    <Property Id="SERVERURL" Secure="yes" />
    <Property Id="BOOTSTRAPTOKEN" Secure="yes" />

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="PBS Plus Agent">
          
          <Component Id="AgentExecutable" Guid="*" Win64="yes">
            <File Id="AgentExe"
                  Source="$(env.AGENT_EXE_PATH)"
                  KeyPath="yes"
                  Checksum="yes" />
            
            <RegistryKey Root="HKLM" Key="SOFTWARE\PBSPlus\Config">
              <RegistryValue Type="string" Name="ServerURL" Value="[SERVERURL]" />
              <RegistryValue Type="string" Name="BootstrapToken" Value="[BOOTSTRAPTOKEN]" />
            </RegistryKey>

            <ServiceInstall Id="PBSPlusAgentService"
                           Name="PBSPlusAgent"
                           DisplayName="PBS Plus Agent"
                           Type="ownProcess"
                           Start="auto"
                           ErrorControl="normal"
                           Account="LocalSystem">
              <util:ServiceConfig
                FirstFailureActionType="restart"
                SecondFailureActionType="restart"
                ThirdFailureActionType="restart"
                RestartServiceDelayInSeconds="5"
                ResetPeriodInDays="0" />
            </ServiceInstall>

            <ServiceControl Id="StartPBSPlusAgent"
                           Name="PBSPlusAgent"
                           Start="install"
                           Stop="both"
                           Remove="uninstall"
                           Wait="yes" />
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Title="PBS Plus Agent" Level="1">
      <ComponentRef Id="AgentExecutable" />
    </Feature>

    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <Dialog Id="ConfigurationDlg" Width="370" Height="270" Title="[ProductName] Configuration">
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.InstallDirDlgBannerBitmap)" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" Text="{\WixUI_Font_Title}Server Configuration" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" Text="Please enter your PBS Plus server details." />
        
        <Control Id="ServerURLLabel" Type="Text" X="25" Y="60" Width="100" Height="15" Text="Server URL:" />
        <Control Id="ServerURLEdit" Type="Edit" X="25" Y="75" Width="320" Height="18" Property="SERVERURL" />
        
        <Control Id="BootstrapTokenLabel" Type="Text" X="25" Y="100" Width="100" Height="15" Text="Bootstrap Token:" />
        <Control Id="BootstrapTokenEdit" Type="Edit" X="25" Y="115" Width="320" Height="18" Property="BOOTSTRAPTOKEN" Password="yes" />
        
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back"><Publish Event="NewDialog" Value="InstallDirDlg">1</Publish></Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next">
          <Publish Event="NewDialog" Value="VerifyReadyDlg">SERVERURL AND BOOTSTRAPTOKEN</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel"><Publish Event="SpawnDialog" Value="CancelDlg">1</Publish></Control>
      </Dialog>
      
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ConfigurationDlg" Order="5">1</Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ConfigurationDlg" Order="5">NOT Installed</Publish>
    </UI>
  </Product>
</Wix>
