#!/bin/sh
set -e

SERVICE_NAME="pbs-plus-agent"
BIN_DIR="/opt/pbs-plus-agent"
BIN_PATH="$BIN_DIR/pbs-plus-agent"
SYMLINK_PATH="/usr/bin/pbs-plus-agent"
STATE_DIR="/var/lib/pbs-plus-agent"
LOG_DIR="/var/log/pbs-plus-agent"
ETC_DIR="/etc/pbs-plus-agent"

is_cmd() { command -v "$1" >/dev/null 2>&1; }
log() { echo "--> $@"; }

detect_system() {
  is_systemd=false
  is_openrc=false
  if [ -d /run/systemd/system ]; then
    is_systemd=true
  elif is_cmd rc-service; then
    is_openrc=true
  fi
}

create_user() {
  if getent passwd pbsplus >/dev/null 2>&1; then 
    log "User pbsplus already exists, skipping creation."
    return 0
  fi
  
  for s in /sbin/nologin /usr/sbin/nologin /bin/false; do
    [ -x "$s" ] && NOLOGIN_SHELL="$s" && break
  done

  if ! getent group pbsplus >/dev/null 2>&1; then
    if is_cmd groupadd; then
      groupadd -r pbsplus || true
    elif is_cmd addgroup; then
      addgroup -S pbsplus 2>/dev/null || addgroup pbsplus || true
    fi
  fi

  if is_cmd useradd; then
    useradd -r -g pbsplus -s "$NOLOGIN_SHELL" -d "$STATE_DIR" -M pbsplus 2>/dev/null || \
    useradd -r -g pbsplus -s "$NOLOGIN_SHELL" -d "$STATE_DIR" pbsplus || true
  elif is_cmd adduser; then
    adduser -S -D -H -s "$NOLOGIN_SHELL" -h "$STATE_DIR" -G pbsplus pbsplus 2>/dev/null || \
    adduser --system --ingroup pbsplus --home "$STATE_DIR" --shell "$NOLOGIN_SHELL" --disabled-password pbsplus || true
  fi
}

setup_binary() {
  log "Setting up binary in $BIN_DIR..."
  
  # Create /opt directory structure
  mkdir -p "$BIN_DIR"
  
  # Set ownership to pbsplus for self-update capability
  chown -R pbsplus:pbsplus "$BIN_DIR"
  chmod 0755 "$BIN_DIR"
  chmod 0755 "$BIN_PATH"
  
  # Set capabilities if available (after chown, as chown strips caps)
  if is_cmd setcap; then
    setcap "cap_dac_read_search,cap_dac_override+ep" "$BIN_PATH" || true
  fi
  
  # Create symlink in /usr/bin
  rm -rf "$SYMLINK_PATH"
  ln -sf "$BIN_PATH" "$SYMLINK_PATH"
  
  log "Binary installed at $BIN_PATH with symlink at $SYMLINK_PATH"
}

setup_permissions_for_updates() {
  # Grant pbsplus user permission to restart the service
  if $is_systemd && [ -d /etc/polkit-1/rules.d ]; then
    cat > /etc/polkit-1/rules.d/10-pbs-plus-agent.rules <<'EOF'
polkit.addRule(function(action, subject) {
    var actions = ["org.freedesktop.systemd1.manage-units", "org.freedesktop.systemd1.reload-daemon"];
    if (actions.indexOf(action.id) !== -1 && subject.user == "pbsplus") {
        var unit = action.lookup("unit");
        if (!unit || unit == "pbs-plus-agent.service" || action.id == "org.freedesktop.systemd1.reload-daemon") {
            return polkit.Result.YES;
        }
    }
});
EOF
    log "Configured Polkit for systemd service management"
  fi

  if is_cmd sudo && [ -d /etc/sudoers.d ]; then
    cat > /etc/sudoers.d/pbs-plus-agent <<EOF
pbsplus ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart $SERVICE_NAME
pbsplus ALL=(ALL) NOPASSWD: /usr/bin/systemctl daemon-reload
pbsplus ALL=(ALL) NOPASSWD: /usr/sbin/rc-service $SERVICE_NAME *
EOF
    chmod 0440 /etc/sudoers.d/pbs-plus-agent
    log "Configured sudoers for service management"
  fi
}

setup_selinux() {
  if command -v getenforce >/dev/null 2>&1 && [ "$(getenforce)" != "Disabled" ]; then
    log "Installing SELinux policy module..."
    
    # Check if policy module exists
    if [ -f /usr/share/selinux/packages/pbs-plus-agent.pp ]; then
      semodule -i /usr/share/selinux/packages/pbs-plus-agent.pp || true
    fi
    
    # Set proper contexts
    semanage fcontext -a -t bin_t "$BIN_DIR(/.*)?" 2>/dev/null || true
    restorecon -Rv "$BIN_DIR" || true
  fi
}

setup_apparmor() {
  if command -v aa-status >/dev/null 2>&1; then
    log "Installing AppArmor profile..."
    
    PROFILE_SRC="/usr/share/pbs-plus-agent/apparmor/opt.pbs-plus-agent.pbs-plus-agent"
    PROFILE_DST="/etc/apparmor.d/opt.pbs-plus-agent.pbs-plus-agent"
    
    if [ -f "$PROFILE_SRC" ]; then
      cp "$PROFILE_SRC" "$PROFILE_DST"
      
      # Load the profile
      apparmor_parser -r "$PROFILE_DST" || true
      
      # Set to enforce mode
      aa-enforce "$PROFILE_DST" 2>/dev/null || true
    fi
  fi
}

setup_service() {
  log "Configuring directories..."
  
  mkdir -p "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  chown -R pbsplus:pbsplus "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  
  [ -f "$ETC_DIR/agent.env" ] || touch "$ETC_DIR/agent.env"
  chown pbsplus:pbsplus "$ETC_DIR/agent.env"
  chmod 0640 "$ETC_DIR/agent.env"

  log "Running service installation..."
  "$BIN_PATH" install
  
  if $is_systemd; then
    systemctl daemon-reload || true
    systemctl reset-failed "$SERVICE_NAME" || true
  fi

  "$BIN_PATH" restart || "$BIN_PATH" start || true
}

main() {
  detect_system
  create_user
  setup_binary
  setup_selinux
  setup_apparmor
  setup_permissions_for_updates
  
  # Linger allows the user to run services without being logged in
  [ "$ENABLE_LINGER" = "true" ] && is_cmd loginctl && loginctl enable-linger pbsplus 2>/dev/null || true
  
  setup_service
  log "Installation complete. Binary: $BIN_PATH"
}

main
