#!/bin/sh
set -e

BIN_PATH="/usr/bin/pbs-plus-agent"
STATE_DIR="/var/lib/pbs-plus-agent"
LOG_DIR="/var/log/pbs-plus-agent"
ETC_DIR="/etc/pbs-plus-agent"

is_cmd() { command -v "$1" >/dev/null 2>&1; }
log() { echo "--> $@"; }

create_user() {
  if getent passwd pbsplus >/dev/null 2>&1; then return 0; fi
  
  for s in /sbin/nologin /usr/sbin/nologin /bin/false; do
    [ -x "$s" ] && NOLOGIN_SHELL="$s" && break
  done

  if is_cmd addgroup; then
    addgroup -S pbsplus 2>/dev/null || addgroup pbsplus
  elif is_cmd groupadd; then
    groupadd -r pbsplus
  fi

  if is_cmd adduser; then
    adduser -S -D -H -s "$NOLOGIN_SHELL" -h "$STATE_DIR" -G pbsplus pbsplus 2>/dev/null || \
    adduser -S -D -s "$NOLOGIN_SHELL" -h "$STATE_DIR" pbsplus
  elif is_cmd useradd; then
    useradd -r -g pbsplus -s "$NOLOGIN_SHELL" -d "$STATE_DIR" pbsplus
  fi
}

setup_service() {
  log "Installing service via pbs-plus-agent..."
  
  mkdir -p "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  chown -R pbsplus:pbsplus "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  
  [ -f "$ETC_DIR/agent.env" ] || touch "$ETC_DIR/agent.env"
  chown pbsplus:pbsplus "$ETC_DIR/agent.env"
  chmod 0640 "$ETC_DIR/agent.env"

  chmod 0755 "$BIN_PATH"
  
  if is_cmd setcap; then
    setcap "cap_dac_read_search,cap_dac_override+ep" "$BIN_PATH"
  fi

  "$BIN_PATH" install
  
  "$BIN_PATH" restart || "$BIN_PATH" start
}

main() {
  create_user
  setup_service
  log "Installation Complete."
}

main
