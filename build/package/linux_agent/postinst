#!/bin/sh
set -e

BIN_PATH="/usr/bin/pbs-plus-agent"
STATE_DIR="/var/lib/pbs-plus-agent"
LOG_DIR="/var/log/pbs-plus-agent"
ETC_DIR="/etc/pbs-plus-agent"

is_cmd() { command -v "$1" >/dev/null 2>&1; }
log() { echo "--> $@"; }

detect_system() {
  is_systemd=false
  is_openrc=false
  if [ -d /run/systemd/system ]; then
    is_systemd=true
  elif is_cmd rc-service; then
    is_openrc=true
  fi
}

create_user() {
  if getent passwd pbsplus >/dev/null 2>&1; then return 0; fi
  
  for s in /sbin/nologin /usr/sbin/nologin /bin/false; do
    [ -x "$s" ] && NOLOGIN_SHELL="$s" && break
  done

  if is_cmd addgroup; then
    addgroup -S pbsplus 2>/dev/null || addgroup pbsplus
  elif is_cmd groupadd; then
    groupadd -r pbsplus
  fi

  if is_cmd adduser; then
    adduser -S -D -H -s "$NOLOGIN_SHELL" -h "$STATE_DIR" -G pbsplus pbsplus 2>/dev/null || \
    adduser -S -D -s "$NOLOGIN_SHELL" -h "$STATE_DIR" pbsplus
  elif is_cmd useradd; then
    useradd -r -g pbsplus -s "$NOLOGIN_SHELL" -d "$STATE_DIR" pbsplus
  fi
}

setup_permissions_for_updates() {
  if $is_systemd && [ -d /etc/polkit-1/rules.d ]; then
    cat > /etc/polkit-1/rules.d/10-pbs-plus-agent.rules <<EOF
polkit.addRule(function(action, subject) {
    var actions = ["org.freedesktop.systemd1.manage-units", "org.freedesktop.systemd1.reload-daemon"];
    if (actions.indexOf(action.id) !== -1 && subject.user == "pbsplus") {
        var unit = action.lookup("unit");
        if (!unit || unit == "$SERVICE_NAME.service" || action.id == "org.freedesktop.systemd1.reload-daemon") {
            return polkit.Result.YES;
        }
    }
});
EOF
    log "Configured Polkit for systemd updates"
  fi

  if is_cmd sudo && [ -d /etc/sudoers.d ]; then
    echo "pbsplus ALL=(ALL) NOPASSWD: /usr/sbin/rc-service $SERVICE_NAME *, /usr/bin/systemctl restart $SERVICE_NAME" > /etc/sudoers.d/pbs-plus-agent
    chmod 0440 /etc/sudoers.d/pbs-plus-agent
    log "Configured Sudoers fallback for service restarts"
  fi
}

setup_service() {
  log "Installing service via pbs-plus-agent..."
  
  mkdir -p "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  chown -R pbsplus:pbsplus "$STATE_DIR" "$LOG_DIR" "$ETC_DIR"
  
  [ -f "$ETC_DIR/agent.env" ] || touch "$ETC_DIR/agent.env"
  chown pbsplus:pbsplus "$ETC_DIR/agent.env"
  chmod 0640 "$ETC_DIR/agent.env"

  chmod 0755 "$BIN_PATH"
  
  if is_cmd setcap; then
    setcap "cap_dac_read_search,cap_dac_override+ep" "$BIN_PATH"
  fi

  "$BIN_PATH" install
  
  "$BIN_PATH" restart || "$BIN_PATH" start
}

main() {
  detect_system
  create_user
  setup_permissions_for_updates
  [ "$ENABLE_LINGER" = "true" ] && is_cmd loginctl && loginctl enable-linger pbsplus 2>/dev/null || true
  setup_service
  log "Installation Complete."
}

main
