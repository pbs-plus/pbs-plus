name: Development Build

on:
  push:

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race ./... -count=1 -timeout 1m

      - name: Build test.Dockerfile
        run: docker build -f test.Dockerfile -t pbs-plus:test .

      - name: Build containerized agent
        run: docker build -f Dockerfile -t pbs-plus-agent:test .

      - name: Make test datastore
        run: mkdir test

      - name: Run container
        run: |
          docker network create pbs-plus-test 2>/dev/null || true
          docker run -d --name pbs-plus-test \
            --network pbs-plus-test \
            -p 8007:8007 \
            -p 8017:8017 \
            -v ./test:/mnt/test \
            --tmpfs /run/proxmox-backup:size=64M \
            pbs-plus:test
          
          # Wait for container to start
          sleep 5
          
          # Check if container is running
          docker ps | grep pbs-plus-test

      - name: Test HTTPS endpoints
        run: |
          echo "Testing port 8007..."
          curl -k -v --max-time 10 https://localhost:8007 2>&1 | tee port_8007.log || true
          
          echo ""
          echo "==================================="
          echo ""
          
          echo "Testing port 8017..."
          curl -k -v --max-time 10 https://localhost:8017 2>&1 | tee port_8017.log || true
          
          echo ""
          echo "==================================="
          echo "Checking if ports responded..."
          echo "==================================="
          
          # Check if port 8007 responded (look for HTTP response or SSL handshake)
          if grep -q -E "(HTTP|SSL|Connected to)" port_8007.log; then
            echo "✓ Port 8007 responded via HTTPS"
          else
            echo "✗ Port 8007 did not respond"
            exit 1
          fi
          
          # Check if port 8017 responded (look for HTTP response or SSL handshake)
          if grep -q -E "(HTTP|SSL|Connected to)" port_8017.log; then
            echo "✓ Port 8017 responded via HTTPS"
          else
            echo "✗ Port 8017 did not respond"
            exit 1
          fi

      - name: Show response contents
        if: always()
        run: |
          echo ""
          echo "==================================="
          echo "Port 8007 Response:"
          echo "==================================="
          cat port_8007.log || echo "No log file found"
          
          echo ""
          echo "==================================="
          echo "Port 8017 Response:"
          echo "==================================="
          cat port_8017.log || echo "No log file found"

      - name: Initialize test baselines
        run: |
          docker exec pbs-plus-test proxmox-backup-manager datastore create test /mnt/test
          curl -k -X POST "https://localhost:8017/api2/extjs/config/disk-backup-job" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "Accept: application/json" \
            -d "id=test-backup-job" \
            -d "target=test-host - Root" \
            -d "subpath=/test-backup" \
            -d "store=test-datastore" \
            -d "ns=test" \
            -d "schedule=" \
            -d "retry=" \
            -d "retry-interval=" \
            -d "max-dir-entries=" \
            -d "mode=" \
            -d "sourcemode=" \
            -d "readmode=" \
            -d "include-xattr=" \
            -d "comment=" \
            -d "rawexclusions=" \
            -d "pre_script=" \
            -d "post_script="
          curl -k -X POST "https://localhost:8017/api2/extjs/config/d2d-token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "Accept: application/json" \
            -d "comment=test-backup"
          echo "PLUS_TOKEN=$(curl -k -s "https://localhost:8017/api2/json/d2d/token" -H "Accept: application/json" | jq -r '.data[0].token')" >> "$GITHUB_ENV"

          if [ -z "$PLUS_TOKEN" ] || [ "$PLUS_TOKEN" = "null" ]; then
            echo "PLUS_TOKEN is empty or null; failing the job."
            exit 1
          fi

      - name: Initialize agent
        run: |
          docker run -d --name pbs-plus-agent \
            --network pbs-plus-test \
            -v ./test:/mnt/test \
            -e PBS_PLUS_INIT_SERVER_URL="https://pbs-plus-test:8008" \
            -e PBS_PLUS_INIT_BOOTSTRAP_TOKEN="${PLUS_TOKEN}" \
            pbs-plus-agent:test

          sleep 10

      - name: Show container logs
        if: always()
        run: |
          echo "==================================="
          echo "Container Logs:"
          echo "==================================="
          docker logs pbs-plus-test

      - name: Show agent logs
        if: always()
        run: |
          echo "==================================="
          echo "Agent Logs:"
          echo "==================================="
          docker logs pbs-plus-agent

      - name: Cleanup
        if: always()
        run: |
          docker rm -f pbs-plus-test || true
          docker rm -f pbs-plus-agent || true
          docker network rm pbs-plus-test || true
