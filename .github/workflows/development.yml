on:
 push:
   branches:
     - main

permissions:
  contents: write
  packages: write

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache: true
      - run: go mod download
      - name: Run Linux tests
        shell: bash
        if: matrix.os == 'ubuntu-latest'
        run: GODEBUG=gctrace=1 go test -v -race ./... -count=1 -timeout 1m

  dev-build-linux-amd64:
    name: dev build linux/amd64
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: wangyoucao577/go-release-action@v1
      id: go_build
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        goos: linux
        goarch: amd64
        compress_assets: false
        executable_compression: upx
        project_path: ./cmd/pbs_plus
        overwrite: true
        release_tag: dev
    - name: pre-packaging script
      env:
        BINARY_PATH: ${{ steps.go_build.outputs.release_asset_dir }}
      run: ./build/package/pre-packaging.sh
    - uses: jiro4989/build-deb-action@v3
      with:
        package: ${{ github.event.repository.name }}
        package_root: build/package/debian
        maintainer: Son Roy Almerol <github@snry.me>
        version: 'refs/tags/v0.0.0'
        arch: 'amd64'
        depends: 'proxmox-backup-server (>= 3.2), proxmox-backup-client (>= 3.2.5), rclone, fuse3'
        desc: 'PBS Plus is a project focused on extending Proxmox Backup Server (PBS) with advanced features to create a more competitive backup solution'
        homepage: 'https://github.com/${{ github.repository }}'
    - name: Pre-release dev build
      uses: softprops/action-gh-release@v1
      with:
        tag_name: dev
        files: ./*.deb
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dev-build-windows-amd64-agent:
    name: dev build agent windows/amd64
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: wangyoucao577/go-release-action@v1
      id: go_build
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        goos: windows
        goarch: amd64
        compress_assets: false
        executable_compression: upx
        binary_name: pbs-plus-agent
        project_path: ./cmd/windows_agent
        ldflags: -H=windowsgui
        overwrite: true
        release_tag: dev

  dev-build-windows-amd64-updater:
    name: dev build updater windows/amd64
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: wangyoucao577/go-release-action@v1
      id: go_build_updater
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        goos: windows
        goarch: amd64
        compress_assets: false
        executable_compression: upx
        binary_name: pbs-plus-updater
        project_path: ./cmd/windows_updater
        ldflags: -H=windowsgui
        overwrite: true
        release_tag: dev
