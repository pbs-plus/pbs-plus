name: Development Build

on:
  push:

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race ./... -count=1 -timeout 1m

      - name: Build test.Dockerfile
        run: docker build -f test.Dockerfile -t pbs-plus:test .

      - name: Run container
        run: |
          docker run -d --name pbs-plus-test \
            -p 8007:8007 \
            -p 8017:8017 \
            --tmpfs /run/proxmox-backup:size=64M \
            pbs-plus:test
          
          # Wait for container to start
          sleep 5
          
          # Check if container is running
          docker ps | grep pbs-plus-test

      - name: Test HTTPS endpoints
        run: |
          echo "Testing port 8007..."
          curl -k -v --max-time 10 https://localhost:8007 2>&1 | tee port_8007.log || true
          
          echo ""
          echo "==================================="
          echo ""
          
          echo "Testing port 8017..."
          curl -k -v --max-time 10 https://localhost:8017 2>&1 | tee port_8017.log || true
          
          echo ""
          echo "==================================="
          echo "Checking if ports responded..."
          echo "==================================="
          
          # Check if port 8007 responded (look for HTTP response or SSL handshake)
          if grep -q -E "(HTTP|SSL|Connected to)" port_8007.log; then
            echo "✓ Port 8007 responded via HTTPS"
          else
            echo "✗ Port 8007 did not respond"
            exit 1
          fi
          
          # Check if port 8017 responded (look for HTTP response or SSL handshake)
          if grep -q -E "(HTTP|SSL|Connected to)" port_8017.log; then
            echo "✓ Port 8017 responded via HTTPS"
          else
            echo "✗ Port 8017 did not respond"
            exit 1
          fi

      - name: Show container logs
        if: always()
        run: |
          echo "==================================="
          echo "Container Logs:"
          echo "==================================="
          docker logs pbs-plus-test

      - name: Show response contents
        if: always()
        run: |
          echo ""
          echo "==================================="
          echo "Port 8007 Response:"
          echo "==================================="
          cat port_8007.log || echo "No log file found"
          
          echo ""
          echo "==================================="
          echo "Port 8017 Response:"
          echo "==================================="
          cat port_8017.log || echo "No log file found"

      - name: Cleanup
        if: always()
        run: docker rm -f pbs-plus-test || true
