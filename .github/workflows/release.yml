name: Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25"

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "GPG_FINGERPRINT=${{ secrets.GPG_FINGERPRINT }}" >> $GITHUB_ENV

      - name: Set environment variables
        run: |
          echo "GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV

      - name: Delete RC tags and releases for this version if final tag
        if: startsWith(github.ref, 'refs/tags/')
        env:
          PUSHED_TAG: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_API: https://api.github.com
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          TAG="$PUSHED_TAG"
          if [[ "$TAG" =~ -rc[0-9]+$ ]]; then
            echo "Pushed tag '$TAG' is an RC tag; skipping RC deletion."
            exit 0
          fi
          BASE="$TAG"
          echo "Final tag detected: $TAG (base: $BASE)"
          git fetch --tags --prune --force
          mapfile -t RC_TAGS < <(git tag -l "${BASE}-rc*")
          if [[ ${#RC_TAGS[@]} -eq 0 ]]; then
            echo "No RC tags found for base '${BASE}'."
            exit 0
          fi
          echo "Found RC tags for deletion:"
          printf ' - %s\n' "${RC_TAGS[@]}"
          delete_release_by_tag() {
            local tag_name="$1"
            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y jq
            fi
            page=1
            found_id=""
            while : ; do
              resp="$(curl -sfSL \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GH_API/repos/$OWNER/$REPO/releases?per_page=100&page=$page")" || break
              id="$(echo "$resp" | jq -r --arg t "$tag_name" \
                    '.[] | select(.tag_name == $t) | .id' | head -n1)"
              if [[ -n "${id:-}" && "$id" != "null" ]]; then
                found_id="$id"
                break
              fi
              count="$(echo "$resp" | jq 'length')"
              if [[ "$count" -lt 100 ]]; then
                break
              fi
              page=$((page+1))
            done
            if [[ -n "${found_id:-}" ]]; then
              echo "Deleting GitHub Release for tag '$tag_name' (id: $found_id)"
              curl -sfSL -X DELETE \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "$GH_API/repos/$OWNER/$REPO/releases/$found_id" >/dev/null
            else
              echo "No GitHub Release found for tag '$tag_name' (ok)."
            fi
          }
          for t in "${RC_TAGS[@]}"; do
            if [[ "$t" =~ ^${BASE}-rc[0-9]+$ ]]; then
              echo "Processing RC tag $t"
              delete_release_by_tag "$t"
              git tag -d "$t" || true
              git push origin ":refs/tags/$t"
            else
              echo "Skipping non-matching tag: $t"
            fi
          done

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract tags and labels
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}-agent
          tags: |
            type=ref,event=tag
            # Add "latest" only for final tags (not -rcN)
            type=raw,value=latest,enable=${{ !contains(github.ref_name, '-rc') }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
