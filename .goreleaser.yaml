version: 2

project_name: pbs-plus

before:
  hooks:
    - go mod tidy

builds:
  # Server build (Linux)
  - id: server
    main: ./cmd/pbs_plus
    binary: pbs-plus
    env:
      - GOEXPERIMENT=greenteagc
      - GOFIPS140=latest
    goos:
      - linux
    goarch:
      - amd64
    ldflags:
      - -X 'main.Version=v{{.Version}}'

  # Linux Agent
  - id: linux-agent
    main: ./cmd/unix_agent
    binary: pbs-plus-agent
    goos:
      - linux
    goarch:
      - amd64
      - arm64
    env:
      - CGO_ENABLED=0
      - GOEXPERIMENT=greenteagc
      - GOFIPS140=latest
    ldflags:
      - -X 'main.Version=v{{.Version}}'
      - -X 'github.com/pbs-plus/pbs-plus/internal/agent/updater.Ed25519PublicKeyB64={{ .Env.ED25519_PUBLIC_KEY_B64 }}'
      - -extld gcc
      - -extldflags "-static"
    flags:
      - -tags=netgo,osusergo
      - -installsuffix=netgo

  # BSD Agent
  - id: freebsd-agent
    main: ./cmd/unix_agent
    binary: pbs-plus-agent
    env:
      - GOEXPERIMENT=greenteagc
      - GOFIPS140=latest
    goos:
      - freebsd
    goarch:
      - amd64
      - arm64
    ldflags:
      - -X 'main.Version=v{{.Version}}'
      - -X 'github.com/pbs-plus/pbs-plus/internal/agent/updater.Ed25519PublicKeyB64={{ .Env.ED25519_PUBLIC_KEY_B64 }}'

  # Windows Agent
  - id: windows-agent
    main: ./cmd/windows_agent
    binary: pbs-plus-agent
    env:
      - GOEXPERIMENT=greenteagc
      - GOFIPS140=latest
    goos:
      - windows
    goarch:
      - amd64
    ldflags:
      - -H=windowsgui
      - -X 'main.Version=v{{.Version}}'
      - -X 'github.com/pbs-plus/pbs-plus/internal/agent/updater.Ed25519PublicKeyB64={{ .Env.ED25519_PUBLIC_KEY_B64 }}'

binary_signs:
  - id: ed25519
    cmd: /tmp/bin/signer
    args:
      - sign
      - "${artifact}"
      - "${signature}"
    signature: "{{ .ProjectName }}-agent-v{{ .Version }}-{{ .Os }}-{{ .Arch }}.sig"
    ids:
      - linux-agent
      - freebsd-agent
      - windows-agent
    artifacts: binary
    output: true

archives:
  - id: server
    ids:
      - server
    name_template: "{{ .ProjectName }}-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    formats:
      - binary

  - id: linux-agent
    ids:
      - linux-agent
    name_template: "{{ .ProjectName }}-agent-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    formats:
      - binary

  - id: freebsd-agent
    ids:
      - freebsd-agent
    name_template: "{{ .ProjectName }}-agent-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    formats:
      - binary

  - id: windows-agent
    ids:
      - windows-agent
    name_template: "{{ .ProjectName }}-agent-v{{ .Version }}-{{ .Os }}-{{ .Arch }}"
    formats:
      - binary

checksum:
  name_template: "{{ .ArtifactName }}.{{ .Algorithm }}"
  algorithm: md5
  split: true

nfpms:
  - id: server-deb
    ids:
      - server
    package_name: "{{ .ProjectName }}"
    vendor: Son Roy Almerol
    homepage: "https://github.com/{{ .Env.GITHUB_REPOSITORY }}"
    maintainer: Son Roy Almerol <github@snry.me>
    description: >
      PBS Plus is a project focused on extending Proxmox Backup Server (PBS) 
      with advanced features to create a more competitive backup solution
    license: MIT
    formats:
      - deb
    dependencies:
      - proxmox-backup-server (>= 3.2)
      - proxmox-backup-client (>= 3.2.5)
      - fuse3
      - memcached
    recommends:
      - pxar-direct-mount
      - pxar-socket-api
    contents:
      - src: ./build/package/server/pbs-plus.service
        dst: /lib/systemd/system/pbs-plus.service
        type: config
    scripts:
      postinstall: ./build/package/server/postinst
    overrides:
      deb:
        file_name_template: "{{ .PackageName }}-v{{ .Version }}-{{ .Arch }}"

  - id: linux-agent-deb
    ids:
      - linux-agent
    package_name: "{{ .ProjectName }}-agent"
    vendor: Son Roy Almerol
    homepage: "https://github.com/{{ .Env.GITHUB_REPOSITORY }}"
    maintainer: Son Roy Almerol <github@snry.me>
    description: >
      PBS Plus Agent - Linux agent for PBS Plus backup solution
    license: MIT
    formats:
      - deb
    contents:
      - src: ./build/package/linux_agent/systemd/pbs-plus-agent.service
        dst: /lib/systemd/system/pbs-plus-agent.service
        type: config
    scripts:
      postinstall: ./build/package/linux_agent/postinst
    overrides:
      deb:
        file_name_template: "{{ .PackageName }}-v{{ .Version }}-{{ .Arch }}"

  - id: linux-agent-rpm
    ids:
      - linux-agent
    package_name: "{{ .ProjectName }}-agent"
    vendor: Son Roy Almerol
    homepage: "https://github.com/{{ .Env.GITHUB_REPOSITORY }}"
    maintainer: Son Roy Almerol <github@snry.me>
    description: >
      PBS Plus Agent - Linux agent for PBS Plus backup solution
    license: MIT
    formats:
      - rpm
    contents:
      - src: ./build/package/linux_agent/systemd/pbs-plus-agent.service
        dst: /usr/lib/systemd/system/pbs-plus-agent.service
        type: config
    scripts:
      postinstall: ./build/package/linux_agent/postinst
    overrides:
      rpm:
        file_name_template: "{{ .PackageName }}-v{{ .Version }}-{{ .Arch }}"

  - id: linux-agent-apk
    ids:
      - linux-agent
    package_name: "{{ .ProjectName }}-agent"
    vendor: Son Roy Almerol
    homepage: "https://github.com/{{ .Env.GITHUB_REPOSITORY }}"
    maintainer: Son Roy Almerol <github@snry.me>
    description: >
      PBS Plus Agent - Linux agent for PBS Plus backup solution
    license: MIT
    formats:
      - apk
    contents:
      - src: ./build/package/linux_agent/openrc/pbs-plus-agent
        dst: /etc/init.d/pbs-plus-agent
        type: config
        file_info:
          mode: 0755
    scripts:
      postinstall: ./build/package/linux_agent/postinst
    overrides:
      apk:
        file_name_template: "{{ .PackageName }}-v{{ .Version }}-{{ .Arch }}"

release:
  github:
    owner: "{{ .Env.GITHUB_REPOSITORY_OWNER }}"
    name: "{{ .Env.GITHUB_REPOSITORY_NAME }}"
  name_template: "PBS Plus {{ .Version }}"
  draft: false
  prerelease: auto
  mode: replace

changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
